<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phoenix Client Dashboard</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
        /* Add basic shadow styling */
        .card { box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .auth-card { transition: all 0.3s ease; }
        .spinner { border-top-color: #f3f3f3; border-left-color: #f3f3f3; border-right-color: #ef4444; }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-8">

    <!-- Main Application Container -->
    <div id="app" class="max-w-6xl mx-auto">
        <!-- Header -->
        <header class="mb-8">
            <div class="card bg-white p-6 rounded-xl flex items-center shadow-lg">
                <!-- Simple Logo Placeholder -->
                <div id="logo-icon" class="w-12 h-12 flex items-center justify-center rounded-full bg-red-600 text-white font-bold text-xl mr-4">P</div>
                <div>
                    <h1 class="text-2xl sm:text-3xl font-extrabold text-gray-800">Phoenix Project: Next 14 Days Client Bookings</h1>
                    <p class="text-sm text-gray-500 mt-1">Targeting Calendar: <span id="calendar-email">Loading...</span></p>
                </div>
            </div>
        </header>

        <!-- Dynamic Content Area -->
        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left Column: Calendar Events -->
            <div class="lg:col-span-2">
                <h2 class="text-xl font-semibold text-gray-700 mb-4 flex items-center">
                    <span id="calendar-icon"></span>
                    Calendar Events
                </h2>
                <div id="summary-section" class="card bg-white p-4 rounded-xl mb-6 text-gray-700">
                    <!-- Summary placeholder -->
                </div>
                <div id="events-container">
                    <!-- Events will be dynamically injected here -->
                    <div id="loading-spinner" class="flex justify-center items-center py-10">
                        <div class="spinner animate-spin rounded-full h-12 w-12 border-4 border-t-4 border-red-500"></div>
                        <p class="ml-4 text-gray-500">Loading events...</p>
                    </div>
                </div>
            </div>

            <!-- Right Column: Tasks -->
            <div class="lg:col-span-1">
                <h2 class="text-xl font-semibold text-gray-700 mb-4 flex items-center">
                    <span id="tasks-icon"></span>
                    Phoenix To Do
                </h2>
                <div id="tasks-container" class="card bg-white p-4 rounded-xl">
                    <!-- Tasks will be dynamically injected here -->
                    <p class="text-gray-500">Loading tasks...</p>
                </div>
            </div>
        </main>
    </div>

    <!-- Authorization/Error Modal Display -->
    <div id="auth-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
        <div id="auth-card" class="auth-card bg-white p-8 rounded-xl max-w-sm w-full text-center shadow-2xl scale-100">
            <div id="modal-content">
                <!-- Content will be injected by JavaScript -->
            </div>
        </div>
    </div>

    <!-- GAPI/GIS Script Loaders -->
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>

    <script>
        // --- CONFIGURATION ---
        // Client ID based on uploaded screenshot (Javascript.png)
        const CLIENT_ID = '234330216775-c4gdq3hshpqmviujm5lmdqnoufptpgdp.apps.googleusercontent.com'; 
        const API_KEY = ''; // KEEP THIS BLANK. Authentication is handled by OAuth.
        // Calendar ID based on uploaded UI screenshots
        const CALENDAR_ID = 'dsa.goldcoast@gmail.com'; 
        // Task list title based on uploaded task list screenshot
        const TASK_LIST_TITLE = 'Phoenix To Do'; 

        // Scopes required for Calendar Read-Only and Tasks Read-Only
        const SCOPES = 'https://www.googleapis.com/auth/calendar.readonly https://www.googleapis.com/auth/tasks.readonly';

        // --- ICON SVGS (Inline Fix to avoid import errors) ---
        // Using inline SVGs for stability
        const ICON_CALENDAR = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-2 text-red-600"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>`;
        const ICON_TASKS = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-2 text-red-600"><rect x="18" y="4" width="3" height="3" fill="currentColor"/><path d="M7 11h14M7 16h14M7 21h14M3 7h1m0 5h1m0 5h1"/></svg>`;
        
        // --- GLOBAL STATE ---
        let tokenClient;
        let isGapiLoaded = false;
        let isGisLoaded = false;
        let authState = 'loading'; // 'loading', 'unauthenticated', 'authenticated', 'error'

        // --- DOM Elements ---
        const authModal = document.getElementById('auth-modal');
        const modalContent = document.getElementById('modal-content');
        const eventsContainer = document.getElementById('events-container');
        const tasksContainer = document.getElementById('tasks-container');
        const summarySection = document.getElementById('summary-section');
        const calendarEmailSpan = document.getElementById('calendar-email');

        // Initial setup of icons and calendar ID display
        document.getElementById('calendar-icon').innerHTML = ICON_CALENDAR;
        document.getElementById('tasks-icon').innerHTML = ICON_TASKS;
        calendarEmailSpan.textContent = CALENDAR_ID;

        // --- UTILITY FUNCTIONS ---

        /** Shows the modal with a specific message and button (if needed). */
        function showModal(title, message, buttonText = null, buttonAction = null) {
            authState = 'unauthenticated';
            authModal.classList.remove('hidden');
            authModal.classList.add('flex');

            modalContent.innerHTML = `
                <div class="text-center">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">${title}</h2>
                    <p class="text-gray-600 mb-6">${message}</p>
                    ${buttonText ? `<button id="modal-button" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150">${buttonText}</button>` : ''}
                </div>
            `;
            const button = document.getElementById('modal-button');
            if (button && buttonAction) {
                button.onclick = buttonAction;
            }

            // Show simplified content when modal is visible
            eventsContainer.innerHTML = '';
            tasksContainer.innerHTML = `<p class="text-gray-500">Tasks failed to load due to authorization error.</p>`;
            summarySection.innerHTML = `<p class="text-gray-500 font-semibold">This dashboard requires access to your Google Calendar and Tasks.</p>`;
        }

        /** Clears and hides the modal. */
        function hideModal() {
            authModal.classList.add('hidden');
            authModal.classList.remove('flex');
        }

        /** Formats an RFC3339 timestamp to a display time string (e.g., '03:00 PM'). */
        function formatTime(dateTimeStr) {
            const date = new Date(dateTimeStr);
            return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
        }

        /** Formats a date object to a display date header (e.g., 'Monday 10 November 2025'). */
        function formatDateHeader(date) {
            return date.toLocaleDateString('en-US', {
                weekday: 'long',
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });
        }

        // --- AUTHENTICATION/INITIALIZATION ---
        
        // IMPORTANT: The onload="gapiLoaded()" and onload="gisLoaded()" attributes in the script tags 
        // will call these functions as soon as the respective libraries are loaded.

        /** Called when the Google API client library (`gapi`) is loaded. */
        window.gapiLoaded = function() {
            isGapiLoaded = true;
            console.log('GAPI loaded.');
            gapi.load('client', initializeGapiClient);
        }

        /** Initializes the Google API client library with project configuration. */
        function initializeGapiClient() {
            // Check if gapi.client exists before proceeding (safety check)
            if (!gapi.client) {
                console.error("GAPI client failed to load.");
                showModal('GAPI Load Failure', 'The core Google API client failed to initialize. Please check your network.', 'Refresh Page', () => window.location.reload());
                return;
            }

            gapi.client.init({
                apiKey: API_KEY, // Note: This should be blank for OAuth
                discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest", "https://www.googleapis.com/discovery/v1/apis/tasks/v1/rest"],
            }).then(() => {
                console.log('GAPI client initialized.');
                checkInitializationStatus();
            }).catch(error => {
                // If the GAPI key is invalid, an error status 400 or 403 might occur.
                const errorMessage = error.details || error.message || 'Unknown GAPI Init Error.';
                console.error("GAPI Client Initialization Error:", error);
                
                // Show a detailed error message if initialization fails
                showModal(
                    'GAPI Client Initialization Error!',
                    `This means your API Key or project settings are incorrect or restricted. Details: ${errorMessage}. Please check your API Key (currently showing ${API_KEY || 'BLANK'}) and Client ID in the Google Cloud Console.`,
                    'Retry'
                );
            });
        }

        /** Called when the Google Identity Services library (`gis`) is loaded. */
        window.gisLoaded = function() {
            isGisLoaded = true;
            console.log('GIS loaded.');
            
            // Check if google.accounts exists before proceeding (safety check)
            if (!google || !google.accounts || !google.accounts.oauth2) {
                console.error("GIS client failed to load.");
                showModal('GIS Load Failure', 'The Google Identity Services client failed to initialize. Please check your network.', 'Refresh Page', () => window.location.reload());
                return;
            }

            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: (tokenResponse) => {
                    // Check if there was an error during token acquisition
                    if (tokenResponse.error) {
                        // User cancelled, or other authorization error occurred
                        console.error('Token acquisition failed:', tokenResponse.error);
                        // Re-show the auth prompt to allow the user to try again
                        showAuthPrompt(); 
                        return;
                    }
                    console.log('Token acquired successfully. Loading data...');
                    // Store the token in session storage to keep the user signed in across refreshes
                    sessionStorage.setItem('access_token', tokenResponse.access_token);
                    gapi.client.setToken(tokenResponse);
                    hideModal();
                    loadDashboardData();
                },
            });
            checkInitializationStatus();
        }

        /** Checks if both GAPI and GIS are loaded and determines the next step. */
        function checkInitializationStatus() {
            if (isGapiLoaded && isGisLoaded) {
                const token = sessionStorage.getItem('access_token');
                if (token) {
                    console.log('Found token, attempting to use it...');
                    gapi.client.setToken({ access_token: token });
                    loadDashboardData();
                } else {
                    console.log('No token found. Showing authorization prompt.');
                    showAuthPrompt();
                }
            }
        }

        /** Displays the 'Authorize Access' prompt. */
        function showAuthPrompt() {
            // Ensure no spinner is running on the main screen
            eventsContainer.innerHTML = ''; 
            tasksContainer.innerHTML = '';
            
            showModal(
                'Access Required',
                'This dashboard requires authorization to securely read your Google Calendar and Tasks data.',
                'Authorize Access',
                handleAuthClick
            );
        }

        /** Initiates the OAuth token request flow. */
        function handleAuthClick() {
            if (tokenClient) {
                // Request a new token with prompt for consent
                tokenClient.requestAccessToken({ prompt: 'consent' });
            } else {
                console.error("Token client not initialized. Cannot perform authentication.");
                showModal(
                    'Initialization Error',
                    'Google Authentication services are not ready. Please check the console for GAPI/GIS load errors and try refreshing.',
                    'Refresh Page',
                    () => window.location.reload()
                );
            }
        }

        // --- DATA LOADING ---

        /** Main function to orchestrate data loading for the entire dashboard. */
        async function loadDashboardData() {
            try {
                // Display loading state
                eventsContainer.innerHTML = `
                    <div id="loading-spinner" class="flex justify-center items-center py-10">
                        <div class="spinner animate-spin rounded-full h-12 w-12 border-4 border-t-4 border-red-500"></div>
                        <p class="ml-4 text-gray-500">Loading client data...</p>
                    </div>
                `;
                tasksContainer.innerHTML = `<p class="text-gray-500">Loading tasks...</p>`;
                summarySection.innerHTML = `<p class="text-gray-500 font-semibold">Fetching data from Google...</p>`;

                // Fetch Calendar and Tasks in parallel
                await Promise.all([
                    fetchCalendarEvents(),
                    fetchTaskLists()
                ]);

                hideModal(); // Ensure modal is hidden if we successfully load
                authState = 'authenticated';
            } catch (error) {
                console.error("Error loading dashboard data:", error);
                
                // If a 401 Unauthorized error occurs, the token is invalid, so re-authorize.
                const status = error.result?.error?.code || error.status;
                
                if (status === 401) {
                    sessionStorage.removeItem('access_token');
                    showAuthPrompt();
                } else {
                    showModal(
                        'Data Load Error',
                        `Failed to fetch data (Status: ${status}). Please try re-authorizing or check the console. Error Message: ${error.result?.error?.message || 'Unknown Error.'}`,
                        'Re-authorize',
                        handleAuthClick
                    );
                }
            }
        }

        /** Fetches and renders the next 14 days of calendar events. */
        async function fetchCalendarEvents() {
            const now = new Date();
            const maxDate = new Date();
            maxDate.setDate(now.getDate() + 14);

            const response = await gapi.client.calendar.events.list({
                'calendarId': CALENDAR_ID,
                'timeMin': now.toISOString(),
                'timeMax': maxDate.toISOString(),
                'showDeleted': false,
                'singleEvents': true,
                'orderBy': 'startTime'
            });

            const events = response.result.items || [];
            renderCalendarEvents(events);
            renderSummary(events);
        }

        /** Renders the event list to the DOM. */
        function renderCalendarEvents(events) {
            eventsContainer.innerHTML = ''; // Clear loading spinner
            if (events.length === 0) {
                eventsContainer.innerHTML = `<p class="text-gray-500 p-4">No upcoming client bookings found in the next 14 days.</p>`;
                return;
            }

            let lastDate = null;
            let html = '';

            events.forEach(event => {
                // Determine start time and notes
                const isAllDay = !event.start.dateTime;
                const startTime = isAllDay ? 'All Day' : formatTime(event.start.dateTime);
                
                // Use start.date for all-day events, start.dateTime for timed events
                const eventDateSource = isAllDay ? event.start.date : event.start.dateTime;
                const eventDate = new Date(eventDateSource);
                const dateHeader = formatDateHeader(eventDate);
                
                // Parse description, filtering out empty lines
                const notes = event.description ? event.description.split('\n').filter(line => line.trim().length > 0) : [];
                const maxNotes = 2; // Display up to 2 lines of notes

                // Add date header if it's a new day
                if (dateHeader !== lastDate) {
                    html += `<h3 class="text-lg font-semibold text-gray-800 border-b border-gray-300 pb-2 mt-6 mb-4">${dateHeader}</h3>`;
                    lastDate = dateHeader;
                }

                // Event Card
                html += `
                    <div class="card bg-white p-4 rounded-xl mb-4 flex transition duration-150 hover:shadow-md">
                        <!-- Time Stamp -->
                        <div class="flex-shrink-0 w-24 text-center border-r pr-4">
                            <p class="text-xl font-bold ${isAllDay ? 'text-green-600' : 'text-red-600'}">${isAllDay ? 'All Day' : eventDate.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }).replace(' ', '&nbsp;')}</p>
                            ${isAllDay ? `<p class="text-xs text-green-600"></p>` : `<p class="text-xs text-gray-500">${eventDate.toLocaleTimeString('en-US', { hour: '2-digit' }).slice(-2)}</p>`}
                        </div>
                        <!-- Event Details -->
                        <div class="flex-grow pl-4">
                            <h4 class="text-lg font-semibold text-gray-800">${event.summary || '(No Title)'}</h4>
                            ${notes.length > 0 ? `
                                <div class="mt-1 text-sm text-gray-600">
                                    <p class="font-bold text-gray-700">Notes:</p>
                                    ${notes.slice(0, maxNotes).map(note => `<p class="truncate">${note}</p>`).join('')}
                                    ${notes.length > maxNotes ? `<p class="text-xs text-red-500 mt-1">...and ${notes.length - maxNotes} more line(s)</p>` : ''}
                                </div>
                            ` : '<p class="text-sm text-gray-500 italic mt-1">No notes provided for this booking.</p>'}
                        </div>
                    </div>
                `;
            });

            eventsContainer.innerHTML = html;
        }

        /** Renders a simple summary of the fetched events. */
        function renderSummary(events) {
            summarySection.innerHTML = `
                <p class="text-lg font-semibold text-gray-700">Bookings Summary</p>
                <p class="text-base text-gray-600 mt-1">You have <span class="font-bold text-red-600">${events.length}</span> upcoming client bookings in the next 14 days.</p>
            `;
        }

        /** Fetches all task lists and then specifically targets the required list. */
        async function fetchTaskLists() {
            const listResponse = await gapi.client.tasks.tasklists.list({});
            const taskLists = listResponse.result.items || [];
            
            // Search for the task list by the configured title
            const targetList = taskLists.find(list => list.title === TASK_LIST_TITLE);

            if (!targetList) {
                renderTaskError(`Task List "${TASK_LIST_TITLE}" not found. Ensure this list exists and its name is an exact, case-sensitive match in your Google Tasks.`);
                return;
            }

            const tasksResponse = await gapi.client.tasks.tasks.list({
                tasklist: targetList.id,
                showCompleted: false,
                // The API can return tasks out of order, sorting is handled client-side
                orderBy: 'position' // A good default, but JS sorts below
            });

            const tasks = tasksResponse.result.items || [];
            renderTasks(tasks);
        }

        /** Renders the task list to the DOM. */
        function renderTasks(tasks) {
            if (tasks.length === 0) {
                tasksContainer.innerHTML = `<p class="text-gray-500">No pending tasks found.</p>`;
                return;
            }
            
            // Organize tasks: filter out completed tasks and build a map for children
            const activeTasks = tasks.filter(task => task.status === 'needsAction');
            const taskMap = {};
            activeTasks.forEach(task => {
                task.children = [];
                taskMap[task.id] = task;
            });

            const topLevelTasks = [];

            // Assign children to their parents
            activeTasks.forEach(task => {
                if (task.parent && taskMap[task.parent]) {
                    taskMap[task.parent].children.push(task);
                } else {
                    topLevelTasks.push(task);
                }
            });

            let html = '';

            topLevelTasks.forEach(task => {
                // Format task date
                const dueDate = task.due 
                    ? new Date(task.due).toLocaleDateString('en-US', { day: 'numeric', month: 'short' })
                    : 'No Due Date';

                html += `
                    <div class="mb-4 p-3 border-l-4 border-red-600 bg-red-50 rounded-md">
                        <div class="flex items-start">
                            <span class="text-lg text-red-600 mr-2 font-bold">•</span>
                            <div class="flex-grow">
                                <p class="font-semibold text-gray-800 leading-tight">${task.title}</p>
                                <p class="text-xs text-gray-500">Due: ${dueDate}</p>
                            </div>
                        </div>
                        
                        ${task.children.length > 0 ? `
                            <ul class="ml-4 mt-2 space-y-1">
                                ${task.children.map(child => `
                                    <li class="flex items-start text-sm text-gray-700">
                                        <span class="text-red-400 mr-2 mt-1">•</span>
                                        ${child.title}
                                    </li>
                                `).join('')}
                            </ul>
                        ` : ''}
                    </div>
                `;
            });
            
            tasksContainer.innerHTML = html;
        }


        /** Renders a specific task error. */
        function renderTaskError(message) {
            tasksContainer.innerHTML = `
                <div class="bg-red-50 border-l-4 border-red-500 p-4 text-sm text-red-700 rounded-lg">
                    <p class="font-bold">Task List Not Found</p>
                    <p>${message}</p>
                </div>
            `;
        }

        // --- Window/Polling Setup ---

        // Simple polling to ensure gapi/gis entry points are available.
        // This is a robust way to handle the asynchronous script loading.
        const maxAttempts = 20;
        let attempt = 0;

        function checkLibraryLoaded() {
            if (attempt >= maxAttempts) {
                console.error("Library Loading Timeout.");
                showModal(
                    'Library Loading Timeout',
                    'Failed to load Google Identity Services (GIS) or GAPI client libraries. Check your network.',
                    'Retry Loading',
                    () => window.location.reload()
                );
                return;
            }

            // Check if the global functions defined in gapi/gis have been created
            const isGapiReady = typeof gapiLoaded === 'function';
            const isGisReady = typeof gisLoaded === 'function';

            if (isGapiReady && isGisReady) {
                console.log('Google library global entry points are defined. Waiting for GAPI/GIS to call them.');
                // The scripts will now call gapiLoaded/gisLoaded themselves via the 'onload' attribute.
            } else {
                // If they're not ready, increment the attempt counter and try again soon
                attempt++;
                setTimeout(checkLibraryLoaded, 250); // Check every 250ms
            }
        }

        // Start the check after the DOM is fully loaded
        window.addEventListener('load', checkLibraryLoaded);
    </script>
</body>
</html>
