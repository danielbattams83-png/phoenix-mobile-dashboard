<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phoenix Client Dashboard</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
        .card { box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .auth-card { transition: all 0.3s ease; }
        .spinner { border-top-color: #f3f3f3; border-left-color: #f3f3f3; border-right-color: #ef4444; }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-8">

    <!-- Main Application Container -->
    <div id="app" class="max-w-6xl mx-auto">
        <!-- Header -->
        <header class="mb-8">
            <div class="card bg-white p-6 rounded-xl flex items-center shadow-lg">
                <div id="logo-icon" class="w-12 h-12 flex items-center justify-center rounded-full bg-red-600 text-white font-bold text-xl mr-4">P</div>
                <div>
                    <h1 class="text-2xl sm:text-3xl font-extrabold text-gray-800">Phoenix Project: Next 14 Days Client Bookings</h1>
                    <p class="text-sm text-gray-500 mt-1">Targeting Calendar: <span id="calendar-email">Loading...</span></p>
                </div>
            </div>
        </header>

        <!-- Dynamic Content Area -->
        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left Column: Calendar Events -->
            <div class="lg:col-span-2">
                <h2 class="text-xl font-semibold text-gray-700 mb-4 flex items-center">
                    <span id="calendar-icon"></span>
                    Calendar Events
                </h2>
                <div id="summary-section" class="card bg-white p-4 rounded-xl mb-6 text-gray-700">
                    <!-- Summary placeholder -->
                </div>
                <div id="events-container">
                    <!-- Events will be dynamically injected here -->
                    <div id="loading-spinner" class="flex justify-center items-center py-10">
                        <div class="spinner animate-spin rounded-full h-12 w-12 border-4 border-t-4 border-red-500"></div>
                        <p class="ml-4 text-gray-500">Loading events...</p>
                    </div>
                </div>
            </div>

            <!-- Right Column: Tasks -->
            <div class="lg:col-span-1">
                <h2 class="text-xl font-semibold text-gray-700 mb-4 flex items-center">
                    <span id="tasks-icon"></span>
                    Phoenix To Do
                </h2>
                <div id="tasks-container" class="card bg-white p-4 rounded-xl">
                    <!-- Tasks will be dynamically injected here -->
                    <p class="text-gray-500">Loading tasks...</p>
                </div>
            </div>
        </main>
    </div>

    <!-- Authorization/Error Modal Display -->
    <div id="auth-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
        <div id="auth-card" class="auth-card bg-white p-8 rounded-xl max-w-sm w-full text-center shadow-2xl scale-100">
            <div id="modal-content">
                <!-- Content will be injected by JavaScript -->
            </div>
        </div>
    </div>

    <!-- GAPI/GIS Script Loaders -->
    <script async defer src="https://apis.google.com/js/api.js"></script>
    <script async defer src="https://accounts.google.com/gsi/client"></script>

    <!-- Lucide Icons Script Fix (Using a reliable bundled version) -->
    <script type="module">
        import { createIcons, Calendar, ClipboardList } from 'https://unpkg.com/lucide@latest';

        // Set the global Lucide icons object
        window.lucideIcons = { Calendar, ClipboardList };

        // Render icons when the script loads
        document.addEventListener('DOMContentLoaded', () => {
            const calendarIconPlaceholder = document.getElementById('calendar-icon');
            if (calendarIconPlaceholder) {
                calendarIconPlaceholder.innerHTML = createIcons({ icons: { Calendar } }).Calendar.toSvg({ class: 'w-6 h-6 mr-2 text-red-600' });
            }
            const tasksIconPlaceholder = document.getElementById('tasks-icon');
            if (tasksIconPlaceholder) {
                tasksIconPlaceholder.innerHTML = createIcons({ icons: { ClipboardList } }).ClipboardList.toSvg({ class: 'w-6 h-6 mr-2 text-red-600' });
            }
        });
    </script>

    <script>
        // --- CONFIGURATION ---
        const CLIENT_ID = 'YOUR_CLIENT_ID_HERE'; // REPLACE WITH YOUR GOOGLE CLOUD CLIENT ID
        const API_KEY = ''; // KEEP THIS BLANK. Authentication is handled by OAuth.
        const CALENDAR_ID = 'YOUR_CALENDAR_ID_HERE'; // REPLACE with the target calendar ID (e.g., email address)
        const TASK_LIST_TITLE = 'Phoenix To Do'; // Task list to search for (case-sensitive)

        // Scopes required for Calendar Read-Only and Tasks Read-Only
        const SCOPES = 'https://www.googleapis.com/auth/calendar.readonly https://www.googleapis.com/auth/tasks.readonly';

        // --- GLOBAL STATE ---
        let tokenClient;
        let isGapiLoaded = false;
        let isGisLoaded = false;
        let authState = 'loading'; // 'loading', 'unauthenticated', 'authenticated', 'error'

        // --- DOM Elements ---
        const authModal = document.getElementById('auth-modal');
        const modalContent = document.getElementById('modal-content');
        const eventsContainer = document.getElementById('events-container');
        const tasksContainer = document.getElementById('tasks-container');
        const summarySection = document.getElementById('summary-section');
        const calendarEmailSpan = document.getElementById('calendar-email');

        // Initial setup of calendar ID display
        calendarEmailSpan.textContent = CALENDAR_ID;

        // --- UTILITY FUNCTIONS ---

        /** Shows the modal with a specific message and button (if needed). */
        function showModal(title, message, buttonText = null, buttonAction = null) {
            authState = 'unauthenticated';
            authModal.classList.remove('hidden');
            authModal.classList.add('flex');

            modalContent.innerHTML = `
                <div class="text-center">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">${title}</h2>
                    <p class="text-gray-600 mb-6">${message}</p>
                    ${buttonText ? `<button id="modal-button" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150">${buttonText}</button>` : ''}
                </div>
            `;
            const button = document.getElementById('modal-button');
            if (button && buttonAction) {
                button.onclick = buttonAction;
            }

            // Hide main content when modal is visible
            eventsContainer.innerHTML = '';
            tasksContainer.innerHTML = `<p class="text-gray-500">Tasks failed to load due to authorization error.</p>`;
            summarySection.innerHTML = `<p class="text-gray-500 font-semibold">This dashboard requires access to your Google Calendar and Tasks.</p>`;
        }

        /** Clears and hides the modal. */
        function hideModal() {
            authModal.classList.add('hidden');
            authModal.classList.remove('flex');
        }

        /** Formats an RFC3339 timestamp to a display time string (e.g., '03:00 PM'). */
        function formatTime(dateTimeStr) {
            const date = new Date(dateTimeStr);
            return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
        }

        /** Formats a date object to a display date header (e.g., 'Monday 10 November 2025'). */
        function formatDateHeader(date) {
            return date.toLocaleDateString('en-US', {
                weekday: 'long',
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });
        }

        // --- AUTHENTICATION/INITIALIZATION ---

        /** Called when the Google API client library (`gapi`) is loaded. */
        window.gapiLoaded = function() {
            isGapiLoaded = true;
            console.log('GAPI loaded.');
            gapi.load('client', initializeGapiClient);
        }

        /** Initializes the Google API client library with project configuration. */
        function initializeGapiClient() {
            gapi.client.init({
                apiKey: API_KEY,
                discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest", "https://www.googleapis.com/discovery/v1/apis/tasks/v1/rest"],
            }).then(() => {
                console.log('GAPI client initialized.');
                checkInitializationStatus();
            }).catch(error => {
                console.error("GAPI Client Initialization Error:", error);
                showModal(
                    'GAPI Client Initialization Error!',
                    `This means your API Key or project settings are incorrect. Details: ${error.details || 'Unknown GAPI Init Error.'}. Please check your API Key (currently showing ${API_KEY || 'BLANK'}) and Client ID in the Google Cloud Console.`,
                    'Retry'
                );
            });
        }

        /** Called when the Google Identity Services library (`gis`) is loaded. */
        window.gisLoaded = function() {
            isGisLoaded = true;
            console.log('GIS loaded.');
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: (tokenResponse) => {
                    if (tokenResponse.error) {
                        console.error('Token acquisition failed:', tokenResponse.error);
                        return;
                    }
                    console.log('Token acquired successfully. Loading data...');
                    sessionStorage.setItem('access_token', tokenResponse.access_token);
                    gapi.client.setToken(tokenResponse);
                    hideModal();
                    loadDashboardData();
                },
            });
            checkInitializationStatus();
        }

        /** Checks if both GAPI and GIS are loaded and determines the next step. */
        function checkInitializationStatus() {
            if (isGapiLoaded && isGisLoaded) {
                const token = sessionStorage.getItem('access_token');
                if (token) {
                    console.log('Found token, attempting to use it...');
                    gapi.client.setToken({ access_token: token });
                    loadDashboardData();
                } else {
                    console.log('No token found. Showing authorization prompt.');
                    showAuthPrompt();
                }
            }
        }

        /** Displays the 'Authorize Access' prompt. */
        function showAuthPrompt() {
            showModal(
                'Access Required',
                'This dashboard requires authorization to securely read your Google Calendar and Tasks data.',
                'Authorize Access',
                handleAuthClick
            );
        }

        /** Initiates the OAuth token request flow. */
        function handleAuthClick() {
            if (tokenClient) {
                // Request a new token
                tokenClient.requestAccessToken({ prompt: 'consent' });
            } else {
                console.error("Token client not initialized. Cannot perform authentication.");
                showModal(
                    'Initialization Error',
                    'Google Authentication services are not ready. Please check the console for GAPI/GIS load errors and try refreshing.',
                    'Refresh Page',
                    () => window.location.reload()
                );
            }
        }

        // --- DATA LOADING ---

        /** Main function to orchestrate data loading for the entire dashboard. */
        async function loadDashboardData() {
            try {
                // Display loading state
                eventsContainer.innerHTML = `
                    <div id="loading-spinner" class="flex justify-center items-center py-10">
                        <div class="spinner animate-spin rounded-full h-12 w-12 border-4 border-t-4 border-red-500"></div>
                        <p class="ml-4 text-gray-500">Loading client data...</p>
                    </div>
                `;
                tasksContainer.innerHTML = `<p class="text-gray-500">Loading tasks...</p>`;
                summarySection.innerHTML = `<p class="text-gray-500 font-semibold">Fetching data from Google...</p>`;

                await Promise.all([
                    fetchCalendarEvents(),
                    fetchTaskLists()
                ]);

                hideModal(); // Ensure modal is hidden if we successfully load
            } catch (error) {
                console.error("Error loading dashboard data:", error);
                // If a 401 Unauthorized error occurs, the token is invalid, so re-authorize.
                if (error.status === 401) {
                    sessionStorage.removeItem('access_token');
                    showAuthPrompt();
                } else {
                    showModal(
                        'Data Load Error',
                        `Failed to fetch data: ${error.result?.error?.message || 'An unknown error occurred.'}. Please try re-authorizing or check the console.`,
                        'Re-authorize',
                        handleAuthClick
                    );
                }
            }
        }

        /** Fetches and renders the next 14 days of calendar events. */
        async function fetchCalendarEvents() {
            const now = new Date();
            const maxDate = new Date();
            maxDate.setDate(now.getDate() + 14);

            const response = await gapi.client.calendar.events.list({
                'calendarId': CALENDAR_ID,
                'timeMin': now.toISOString(),
                'timeMax': maxDate.toISOString(),
                'showDeleted': false,
                'singleEvents': true,
                'orderBy': 'startTime'
            });

            const events = response.result.items || [];
            renderCalendarEvents(events);
            renderSummary(events);
        }

        /** Renders the event list to the DOM. */
        function renderCalendarEvents(events) {
            eventsContainer.innerHTML = ''; // Clear loading spinner
            if (events.length === 0) {
                eventsContainer.innerHTML = `<p class="text-gray-500 p-4">No upcoming client bookings found in the next 14 days.</p>`;
                return;
            }

            let lastDate = null;
            let html = '';

            events.forEach(event => {
                // Determine start time and notes
                const isAllDay = !event.start.dateTime;
                const startTime = isAllDay ? 'All Day' : formatTime(event.start.dateTime);
                const eventDate = isAllDay ? new Date(event.start.date) : new Date(event.start.dateTime);
                const dateHeader = formatDateHeader(eventDate);
                const notes = event.description ? event.description.split('\n').filter(line => line.trim().length > 0) : [];
                const maxNotes = 2; // Display up to 2 lines of notes

                // Add date header if it's a new day
                if (dateHeader !== lastDate) {
                    html += `<h3 class="text-lg font-semibold text-gray-800 border-b border-gray-300 pb-2 mt-6 mb-4">${dateHeader}</h3>`;
                    lastDate = dateHeader;
                }

                // Event Card
                html += `
                    <div class="card bg-white p-4 rounded-xl mb-4 flex transition duration-150 hover:shadow-md">
                        <!-- Time Stamp -->
                        <div class="flex-shrink-0 w-24 text-center border-r pr-4">
                            <p class="text-xl font-bold ${isAllDay ? 'text-green-600' : 'text-red-600'}">${isAllDay ? 'All Day' : eventDate.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }).replace(' ', '&nbsp;')}</p>
                            ${isAllDay ? `<p class="text-xs text-green-600"></p>` : `<p class="text-xs text-gray-500">${eventDate.toLocaleTimeString('en-US', { hour: '2-digit' }).slice(-2)}</p>`}
                        </div>
                        <!-- Event Details -->
                        <div class="flex-grow pl-4">
                            <h4 class="text-lg font-semibold text-gray-800">${event.summary || '(No Title)'}</h4>
                            ${notes.length > 0 ? `
                                <div class="mt-1 text-sm text-gray-600">
                                    <p class="font-bold text-gray-700">Notes:</p>
                                    ${notes.slice(0, maxNotes).map(note => `<p>${note}</p>`).join('')}
                                    ${notes.length > maxNotes ? `<p class="text-xs text-red-500 mt-1">...and more details</p>` : ''}
                                </div>
                            ` : '<p class="text-sm text-gray-500 italic mt-1">No notes provided for this booking.</p>'}
                        </div>
                    </div>
                `;
            });

            eventsContainer.innerHTML = html;
        }

        /** Renders a simple summary of the fetched events. */
        function renderSummary(events) {
            summarySection.innerHTML = `
                <p class="text-lg font-semibold text-gray-700">Bookings Summary</p>
                <p class="text-base text-gray-600 mt-1">You have <span class="font-bold text-red-600">${events.length}</span> upcoming client bookings in the next 14 days.</p>
            `;
        }

        /** Fetches all task lists and then specifically targets the required list. */
        async function fetchTaskLists() {
            const listResponse = await gapi.client.tasks.tasklists.list({});
            const taskLists = listResponse.result.items || [];
            const targetList = taskLists.find(list => list.title === TASK_LIST_TITLE);

            if (!targetList) {
                renderTaskError(`Task List "${TASK_LIST_TITLE}" not found. Ensure this list exists and its name is an exact, case-sensitive match.`);
                return;
            }

            const tasksResponse = await gapi.client.tasks.tasks.list({
                tasklist: targetList.id,
                showCompleted: false,
                showHidden: false // This means we only get top-level tasks and their immediate children
            });

            const tasks = tasksResponse.result.items || [];
            renderTasks(tasks);
        }

        /** Renders the task list to the DOM. */
        function renderTasks(tasks) {
            if (tasks.length === 0) {
                tasksContainer.innerHTML = `<p class="text-gray-500">No pending tasks found.</p>`;
                return;
            }

            let html = '';

            tasks.forEach(task => {
                // Only show top-level tasks (those without a parent)
                if (!task.parent) {
                    // Find all child tasks
                    const childTasks = tasks.filter(t => t.parent === task.id);
                    const hasChildren = childTasks.length > 0;
                    
                    // Format task date
                    const dueDate = task.due 
                        ? new Date(task.due).toLocaleDateString('en-US', { day: 'numeric', month: 'short' })
                        : 'No Due Date';

                    html += `
                        <div class="mb-3 p-2 border-l-4 ${hasChildren ? 'border-red-400' : 'border-red-600'}">
                            <div class="flex items-start">
                                <span class="text-lg text-red-600 mr-2">•</span>
                                <div class="flex-grow">
                                    <p class="font-semibold text-gray-800 leading-tight">${task.title}</p>
                                    <p class="text-xs text-gray-500">${dueDate}</p>
                                </div>
                            </div>
                            
                            ${hasChildren ? `
                                <ul class="ml-4 mt-1 space-y-1">
                                    ${childTasks.map(child => `
                                        <li class="flex items-start text-sm text-gray-600">
                                            <span class="text-red-400 mr-2">•</span>
                                            ${child.title}
                                        </li>
                                    `).join('')}
                                </ul>
                            ` : ''}
                        </div>
                    `;
                }
            });
            
            tasksContainer.innerHTML = html;
        }

        /** Renders a specific task error. */
        function renderTaskError(message) {
            tasksContainer.innerHTML = `
                <div class="bg-red-50 border-l-4 border-red-500 p-4 text-sm text-red-700 rounded-lg">
                    <p class="font-bold">Task Error</p>
                    <p>${message}</p>
                </div>
            `;
        }

        // --- Window/Polling Setup ---

        // Use a simple polling mechanism to check if GAPI and GIS have loaded.
        // This is necessary because the scripts are loaded asynchronously.
        const maxAttempts = 20;
        let attempt = 0;

        function checkLibraryLoaded() {
            if (attempt >= maxAttempts) {
                console.error("Library Loading Timeout.");
                showModal(
                    'Library Loading Timeout',
                    'Failed to load Google Identity Services (GIS) or GAPI client libraries after 5 seconds. Check your network connection or if a strict Content Security Policy is blocking external scripts.',
                    'Retry Loading',
                    () => window.location.reload()
                );
                return;
            }

            // Check if the global functions defined in gapi/gis have been created
            const isGapiReady = typeof gapiLoaded === 'function';
            const isGisReady = typeof gisLoaded === 'function';

            if (isGapiReady && isGisReady) {
                // We don't call them here, but the async scripts will call them automatically
                // The global functions are the entry points. We just wait for them to finish.
                console.log('Google library global entry points are defined. Waiting for GAPI/GIS to call them.');
                // We'll trust the gapiLoaded and gisLoaded callbacks to handle initialization.
            } else {
                // If they're not ready, increment the attempt counter and try again soon
                attempt++;
                setTimeout(checkLibraryLoaded, 250); // Check every 250ms
            }
        }

        // Start the check after the DOM is fully loaded
        window.addEventListener('load', checkLibraryLoaded);
    </script>
</body>
</html>
