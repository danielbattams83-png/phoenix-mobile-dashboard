<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phoenix Project: Next 14 Days Client Bookings</title>
    <!-- Load Tailwind CSS from CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide Icons for aesthetic elements -->
    <script type="module">
        import { createIcons, CalendarCheck, ClipboardList, Info, Loader2 } from 'https://cdn.jsdelivr.net/npm/lucide-esm@latest';
        createIcons({ icons: { CalendarCheck, ClipboardList, Info, Loader2 } });
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9; /* Light slate background */
            min-height: 100vh;
        }
        /* Custom scrollbar for better appearance */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        /* Style for the main container to ensure centering and responsiveness */
        #app-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }
        .task-list {
            max-height: 500px; /* Limit height for tasks */
            overflow-y: auto;
        }
        /* Style for disabled button state */
        .auth-button-disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div id="app-container">
        <!-- Header -->
        <header class="text-center py-6">
            <div class="flex items-center justify-center space-x-3 bg-white p-6 rounded-2xl shadow-xl">
                <img src="https://placehold.co/60x60/f87171/ffffff?text=P" onerror="this.src='https://placehold.co/60x60/f87171/ffffff?text=P'" alt="Phoenix Logo Placeholder" class="rounded-full">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800">Phoenix Project: Next 14 Days Client Bookings</h1>
                    <p class="text-sm text-gray-500 mt-1">Targeting Calendar: <span id="calendar-email-display" class="font-semibold text-red-500">Loading...</span></p>
                </div>
            </div>
        </header>

        <!-- Authorization Section -->
        <div id="auth-section" class="text-center my-8 p-8 bg-white rounded-2xl shadow-lg border-2 border-red-300 hidden">
            <i data-lucide="info" class="w-8 h-8 mx-auto text-red-500 mb-4"></i>
            <p id="auth-message" class="text-gray-600 mb-4">
                Checking API status...
            </p>
            <button id="authorize_button" disabled class="bg-red-600 text-white font-semibold py-3 px-6 rounded-xl shadow-lg transition duration-200 auth-button-disabled">
                Authorize Access
            </button>
        </div>

        <!-- Dashboard Content -->
        <div id="content-section" class="hidden">
            <!-- Loading Indicator -->
            <div id="loading-indicator" class="text-center py-12">
                <i data-lucide="loader-2" class="w-10 h-10 mx-auto text-red-500 animate-spin"></i>
                <p class="mt-4 text-gray-600">Loading events and tasks...</p>
            </div>

            <!-- Error Message Area -->
            <div id="error-message" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-xl relative mb-6 hidden" role="alert">
                <strong class="font-bold">API Initialization Error!</strong>
                <span id="error-details" class="block sm:inline"></span>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

                <!-- Left Column: Calendar Events -->
                <div class="lg:col-span-2">
                    <!-- Bookings Summary Card -->
                    <div class="bg-white p-6 rounded-2xl shadow-md mb-6">
                        <h2 class="text-xl font-semibold text-gray-800 mb-2">Bookings Summary</h2>
                        <p class="text-gray-600">
                            You have <span id="event-count" class="text-2xl font-bold text-red-600">...</span> upcoming client bookings in the next 14 days.
                        </p>
                    </div>

                    <!-- Calendar Events List -->
                    <div id="calendar-events-list" class="space-y-4">
                        <!-- Events will be dynamically inserted here -->
                    </div>
                </div>

                <!-- Right Column: Tasks List -->
                <div class="lg:col-span-1">
                    <div class="bg-white p-6 rounded-2xl shadow-xl">
                        <h2 class="text-xl font-semibold text-gray-800 flex items-center mb-4">
                            <i data-lucide="clipboard-list" class="w-6 h-6 mr-2 text-red-500"></i> Phoenix To Do
                            <a id="tasks-external-link" href="#" target="_blank" class="ml-auto text-gray-400 hover:text-red-500 transition duration-150">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-external-link"><path d="M15 3h6v6"/><path d="M10 14 21 3"/><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/></svg>
                            </a>
                        </h2>
                        <div id="tasks-list" class="task-list space-y-3">
                            <p class="text-gray-500">Loading tasks...</p>
                            <!-- Tasks will be dynamically inserted here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Google API Scripts: Loaded without onload attributes to use polling instead -->
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>

    <script>
        // --- CONFIGURATION ---
        const CLIENT_ID = '234330216775-c4gdq3hshpqmviujm5lmdqnoufptpgdp.apps.googleusercontent.com';
        const API_KEY = ''; 
        const CALENDAR_ID = 'dsa.goldcoast@gmail.com'; 
        const TASK_LIST_TITLE = 'Phoenix To Do'; 

        // --- SCOPES AND DISCOVERY ---
        const SCOPES = 'https://www.googleapis.com/auth/calendar.readonly https://www.googleapis.com/auth/tasks.readonly';
        let tokenClient;
        let authReady = false;

        // --- DOM Elements ---
        const authSection = document.getElementById('auth-section');
        const contentSection = document.getElementById('content-section');
        const loadingIndicator = document.getElementById('loading-indicator');
        const errorMessage = document.getElementById('error-message');
        const errorDetails = document.getElementById('error-details');
        const calendarEventsList = document.getElementById('calendar-events-list');
        const tasksList = document.getElementById('tasks-list');
        const eventCountSpan = document.getElementById('event-count');
        const calendarEmailDisplay = document.getElementById('calendar-email-display');
        const authorizeButton = document.getElementById('authorize_button');
        const authMessage = document.getElementById('auth-message');

        calendarEmailDisplay.textContent = CALENDAR_ID;

        // --- UTILITY FUNCTIONS ---

        function showAuthSection() {
            authSection.classList.remove('hidden');
            contentSection.classList.add('hidden');
            loadingIndicator.classList.add('hidden');
            errorMessage.classList.add('hidden');
        }

        function showContentSection() {
            authSection.classList.add('hidden');
            contentSection.classList.remove('hidden');
        }

        function displayError(details) {
            console.error("API Error:", details);
            loadingIndicator.classList.add('hidden');
            contentSection.classList.remove('hidden');
            errorMessage.classList.remove('hidden');
            errorDetails.textContent = details;
            calendarEventsList.innerHTML = '';
            tasksList.innerHTML = '<p class="text-red-500 font-semibold">Tasks failed to load due to authorization error.</p>';
        }

        function enableAuthorizeButton() {
            authorizeButton.disabled = false;
            authorizeButton.classList.remove('auth-button-disabled');
            authorizeButton.classList.add('hover:bg-red-700');
            authMessage.textContent = 'This dashboard requires access to your Google Calendar and Tasks.';
            authorizeButton.addEventListener('click', handleAuthClick, { once: true });
        }


        // --- AUTH & INITIALIZATION ---
        
        /**
         * The robust polling mechanism to ensure both GAPI and GIS are defined before init.
         */
        function waitForApiReady() {
            // Check for both gapi and google.accounts objects
            if (typeof gapi !== 'undefined' && typeof google.accounts !== 'undefined') {
                console.log("GAPI and GIS objects are available. Proceeding with initialization.");
                initGapiClient();
            } else {
                console.log("Waiting for GAPI and GIS to load...");
                // Re-run this check in 100ms
                setTimeout(waitForApiReady, 100);
            }
        }

        /**
         * Initializes the GAPI client library.
         */
        function initGapiClient() {
            gapi.load('client', () => {
                gapi.client.init({
                    apiKey: API_KEY,
                    discoveryDocs: [
                        'https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest', 
                        'https://www.googleapis.com/discovery/v1/apis/tasks/v1/rest'
                    ],
                }).then(() => {
                    initGisClient();
                }).catch(e => {
                    displayError('GAPI Client Initialization Error. Details: ' + (e.details || 'Unknown Init Error. Check API Key/Project setup.'));
                });
            });
        }

        /**
         * Initializes the GIS token client.
         */
        function initGisClient() {
             tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: (tokenResponse) => {
                    // This callback runs after the user authorizes or denies access
                    if (tokenResponse && tokenResponse.access_token) {
                        sessionStorage.setItem('access_token', tokenResponse.access_token);
                        gapi.client.setToken(tokenResponse);
                        showContentSection();
                        fetchData();
                    } else {
                         // If auth fails or is denied, revert to show auth button
                        showAuthSection(); 
                        enableAuthorizeButton();
                    }
                },
            });

            authReady = true;
            // Check for existing token and trigger silent sign-in if needed
            checkExistingToken();
        }

        /**
         * Checks if a token exists and tries to use it.
         */
        function checkExistingToken() {
            const storedToken = sessionStorage.getItem('access_token');
            if (storedToken) {
                // Set the token (even if it's expired) to try and use it
                gapi.client.setToken({ access_token: storedToken });
                showContentSection();
                // Attempt to fetch data immediately, fetchData will handle token expiry errors
                fetchData();
            } else {
                // No token, prompt user to authorize
                showAuthSection();
                enableAuthorizeButton();
            }
        }
        
        /**
         * Initiates the Google Authorization process (called by button click).
         */
        function handleAuthClick() {
            if (!authReady) {
                console.warn("Authentication services not fully initialized yet.");
                return; 
            }

            if (gapi.client.getToken() === null) {
                // Request consent for first time access
                tokenClient.requestAccessToken({ prompt: 'consent' });
            } else {
                // Token set (may be expired), try silent refresh
                tokenClient.requestAccessToken({ prompt: '' });
            }
        }


        /**
         * Fetches both calendar events and tasks concurrently.
         */
        async function fetchData() {
            loadingIndicator.classList.remove('hidden');
            errorMessage.classList.add('hidden');

            try {
                // Attempt to refresh the token silently first (if already authorized)
                // This isn't strictly necessary as requestAccessToken handles it, but good practice.
                // For simplicity, we rely on the main API calls to fail gracefully.
                
                await Promise.all([
                    listUpcomingEvents(),
                    listTasks()
                ]);

            } catch (e) {
                console.error("Fetch Data Error:", e);
                // The error is likely an expired token or permission issue (401/403)
                displayError('Failed to fetch data. Please re-authorize. Details: ' + (e.message || 'Unknown network or API error.'));
                sessionStorage.removeItem('access_token');
                showAuthSection();
                enableAuthorizeButton();
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        }

        // --- CALENDAR FUNCTIONS (Unchanged) ---
        async function listUpcomingEvents() {
            const now = new Date();
            const maxTime = new Date();
            maxTime.setDate(now.getDate() + 14);

            let response;
            try {
                response = await gapi.client.calendar.events.list({
                    'calendarId': CALENDAR_ID,
                    'timeMin': now.toISOString(),
                    'timeMax': maxTime.toISOString(),
                    'showDeleted': false,
                    'singleEvents': true,
                    'maxResults': 50,
                    'orderBy': 'startTime',
                });
            } catch (err) {
                throw new Error('Calendar API Error: ' + err.result.error.message);
            }

            const events = response.result.items;
            eventCountSpan.textContent = events.length;

            if (!events || events.length === 0) {
                calendarEventsList.innerHTML = '<p class="text-gray-500 p-4 bg-white rounded-xl shadow-md">No upcoming events found in the next 14 days.</p>';
                return;
            }

            calendarEventsList.innerHTML = ''; 
            let lastDate = '';

            events.forEach((event) => {
                const start = event.start.dateTime || event.start.date;
                const startDate = new Date(start);
                const isAllDay = !event.start.dateTime;

                const dateString = startDate.toLocaleDateString('en-AU', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });

                if (dateString !== lastDate) {
                    calendarEventsList.innerHTML += `
                        <h3 class="text-xl font-bold text-gray-700 mt-6 mb-2 border-b-2 border-red-200 pb-1">${dateString}</h3>
                    `;
                    lastDate = dateString;
                }

                const timeString = isAllDay
                    ? 'All Day'
                    : startDate.toLocaleTimeString('en-AU', { hour: '2-digit', minute: '2-digit', hour12: true });

                const notes = event.description ? event.description.split('\n').filter(line => line.trim().length > 0).map(line => `<p class="text-sm italic text-gray-500">${line}</p>`).join('') : '';

                calendarEventsList.innerHTML += `
                    <div class="flex bg-white p-5 rounded-xl shadow-md hover:shadow-lg transition duration-200 border-l-4 ${isAllDay ? 'border-indigo-500' : 'border-red-500'}">
                        <div class="w-20 text-center mr-4">
                            <span class="block text-2xl font-semibold ${isAllDay ? 'text-indigo-600' : 'text-red-600'}">${timeString.split(' ')[0]}</span>
                            <span class="block text-xs uppercase text-gray-500">${timeString.split(' ')[1] || ''}</span>
                        </div>
                        <div class="flex-grow">
                            <p class="text-lg font-semibold text-gray-800">${event.summary || '(No Title)'}</p>
                            ${notes ? `<div class="mt-2">${notes}</div>` : ''}
                        </div>
                    </div>
                `;
            });
        }


        // --- TASKS FUNCTIONS (Unchanged) ---
        async function listTasks() {
            tasksList.innerHTML = '<p class="text-gray-500 flex items-center"><i data-lucide="loader-2" class="w-4 h-4 mr-2 animate-spin"></i> Loading tasks...</p>';

            let taskListId = null;

            // 1. Find the Task List ID
            try {
                const taskListsResponse = await gapi.client.tasks.tasklists.list({});
                const targetList = taskListsResponse.result.items.find(list => list.title === TASK_LIST_TITLE);

                if (!targetList) {
                    tasksList.innerHTML = `<p class="text-red-500 font-semibold">Task List "${TASK_LIST_TITLE}" not found. Please ensure the title is an exact, case-sensitive match.</p>`;
                    return;
                }
                taskListId = targetList.id;
                tasksExternalLink.href = `https://mail.google.com/tasks/canvas?id=${taskListId}&edit=1`;

            } catch (err) {
                throw new Error('Failed to find task lists. Check authorization or API status.');
            }

            // 2. Fetch Tasks using the ID
            try {
                const tasksResponse = await gapi.client.tasks.tasks.list({
                    'tasklist': taskListId,
                    'showCompleted': false,
                    'showHidden': false,
                });
                const tasks = tasksResponse.result.items;

                tasksList.innerHTML = '';

                if (!tasks || tasks.length === 0) {
                    tasksList.innerHTML = '<p class="text-gray-500">No pending tasks in the Phoenix To Do list. Great job!</p>';
                    return;
                }

                tasks.forEach(task => {
                    const hasDueDate = task.due ? new Date(task.due) : null;
                    const dueDateString = hasDueDate ? hasDueDate.toLocaleDateString('en-AU', { day: 'numeric', month: 'short' }) : 'No Due Date';

                    tasksList.innerHTML += `
                        <div class="flex items-start space-x-3 p-2 border-b border-gray-100 last:border-b-0 hover:bg-gray-50 rounded-lg transition duration-150">
                            <input type="checkbox" disabled class="mt-1.5 w-4 h-4 text-red-600 bg-gray-100 border-gray-300 rounded focus:ring-red-500">
                            <div class="flex-grow">
                                <p class="text-sm font-medium text-gray-900">${task.title}</p>
                                <p class="text-xs text-gray-500">${dueDateString}</p>
                            </div>
                        </div>
                    `;
                });

            } catch (err) {
                throw new Error('Failed to load tasks. Check authorization.');
            }
        }

        // Initial entry point: Start waiting for APIs to load
        window.onload = function() {
            showAuthSection(); 
            waitForApiReady();
        };

    </script>
</body>
</html>
